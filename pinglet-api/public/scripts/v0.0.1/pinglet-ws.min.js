((global) => {
	const PingletWS = {
		_sockets: [],
		init({ endpoint, expectedDomains = [], projectIds = [] }) {
			const domain = location.hostname.replace(/^www\./, "");
			const matched = expectedDomains.some((d) => domain.endsWith(d));
			if (!matched) {
				this._showPopup(
					"⚠️ Domain mismatch",
					`Expected: ${expectedDomains.join(", ")}<br>Found: ${domain}`,
				);
				return;
			}

			projectIds.forEach((pid) => {
				const wsUrl = `${endpoint.replace(/^http/, "ws")}?projectId=${encodeURIComponent(pid)}`;
				const socket = new WebSocket(wsUrl);

				socket.onmessage = (e) => {
					try {
						const { title, message } = JSON.parse(e.data);
						this._showNotification(title, message);
					} catch (err) {
						console.warn("Invalid message:", err);
					}
				};

				socket.onerror = (err) => {
					console.warn("Pinglet WS error:", err);
				};

				this._sockets.push(socket);
			});
		},

		_showNotification(title, message) {
			const wrapper = this._getWrapper();
			const toast = document.createElement("div");
			toast.className = "pinglet-toast";
			toast.innerHTML = `<strong>${title}</strong><br>${message}`;
			wrapper.appendChild(toast);
			setTimeout(() => toast.remove(), 5000);
		},

		_showPopup(title, msg) {
			const el = document.createElement("div");
			el.style =
				"position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#f44336;color:#fff;padding:12px 16px;border-radius:6px;z-index:99999;font-family:sans-serif";
			el.innerHTML = `<strong>${title}</strong><br>${msg}`;
			document.body.appendChild(el);
			setTimeout(() => el.remove(), 8000);
		},

		_getWrapper() {
			let wrap = document.getElementById("pinglet-wrapper");
			if (!wrap) {
				wrap = document.createElement("div");
				wrap.id = "pinglet-wrapper";
				wrap.style =
					"position:fixed;bottom:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;max-width:300px;font-family:sans-serif";
				document.body.appendChild(wrap);
			}
			this._addBranding(wrap);
			return wrap;
		},

		_addBranding(wrap) {
			if (!document.getElementById("pinglet-brand")) {
				const el = document.createElement("div");
				el.id = "pinglet-brand";
				el.style = "font-size:10px;text-align:right;color:#aaa;margin-top:8px";
				el.innerHTML = "Powered by <strong>Pinglet</strong> – Enjos";
				wrap.appendChild(el);
			}
		},
	};

	global.PingletWidget = PingletWS;
})(window);
