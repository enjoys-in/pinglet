((global) => {
  injectFont();
  const globalConfig = {
    style: {
      color: "#fff",
      backgroundColor: "#000",
    },
    position: "bottom-left",
    transition: "fade", // or "slide", "zoom"
    branding: {
      show: true,
      html: 'Powered by <a href="https://pinglet.enjoys.in" style="color:#4da6ff;text-decoration:none;" target="_blank">Pinglet</a> - Enjoys',
    },
    sound: {
      play: true,
      src: "https://pinglet.enjoys.in/api/v1/pinglet-sound.mp3?v=1&ext=mp3",
    },
    duration: 2000,
  };
  const PINGLET_ID = "pinglet-wrapper";
  let toastCount = 0;
  let brandingEl = null;
  function injectFont() {
    // Inject Google Font
    const fontLink = document.createElement("link");
    fontLink.rel = "stylesheet";
    fontLink.href =
      "https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap";
    document.head.appendChild(fontLink);

    // Inject font override for all .pinglet-* classes
    const fontStyle = document.createElement("style");
    fontStyle.innerHTML = `
    [class^="pinglet-"],
    [class*=" pinglet-"] {
      font-family: 'Inter', sans-serif !important;
    }
  `;
    document.head.appendChild(fontStyle);
  }

  const Widget = {
    createMediaElement(media, title = "Pinglet Notification") {
      let el;

      switch (media.type) {
        case "image":
          el = document.createElement("img");
          el.src = media.src;
          el.alt = title;
          break;

        case "video":
          el = document.createElement("video");
          el.src = media.src;
          el.controls = true;

          el.setAttribute("playsinline", "");
          el.setAttribute("muted", "");
          break;

        case "audio":
          el = document.createElement("audio");
          el.src = media.src;
          el.controls = true;
          break;

        case "icon":
          el = document.createElement("span");
          el.className = `icon-${media.src}`; // You can customize this logic
          el.setAttribute("aria-label", title);
          break;

        default:
          // fallback to image
          el = document.createElement("img");
          el.src = media.src;
          el.alt = title;
      }

      if (["image", "video", "audio"].includes(media.type)) {
        Object.assign(el.style, {
          width: "100%",
          maxWidth: "320px", // limit to reasonable size
          height: "auto", // auto height for img/video
          borderRadius: "10px",
          marginBottom: "8px",
          display: "block",
        });

        // Special fixed height for audio player
        if (media.type === "audio") {
          el.style.height = "40px";
        }

        // Optional: Force fixed height for video/image too
        if (media.type === "video" || media.type === "image") {
          el.style.height = "180px";
          el.style.objectFit = "cover";
        }
      }

      return el;
    },

    createWrapper(position = "bottom-right") {
      let wrapper = document.getElementById(PINGLET_ID);
      if (!wrapper) {
        wrapper = document.createElement("div");
        wrapper.id = PINGLET_ID;
        Object.assign(wrapper.style, {
          position: "fixed",
          zIndex: 99999,
          display: "flex",
          flexDirection: "column",
          gap: "10px",
          maxWidth: "calc(100vw - 20px)",
          padding: "12px",
          pointerEvents: "none",
        });

        const positions = {
          "top-left": { top: "0", left: "0", alignItems: "flex-start" },
          "top-right": { top: "0", right: "0", alignItems: "flex-end" },
          "bottom-left": { bottom: "0", left: "0", alignItems: "flex-start" },
          "bottom-right": { bottom: "0", right: "0", alignItems: "flex-end" },
          "top-center": {
            top: "0",
            left: "50%",
            transform: "translateX(-50%)",
            alignItems: "center",
          },
          "bottom-center": {
            bottom: "0",
            left: "50%",
            transform: "translateX(-50%)",
            alignItems: "center",
          },
        };

        Object.assign(
          wrapper.style,
          positions[position] || positions["bottom-right"]
        );

        document.body.appendChild(wrapper);
      }
      return wrapper;
    },
    playNotificationSound({ play, src }) {
      if (!play || !src) return;

      const audio = new Audio(src);
      audio.play().catch((err) => {});
    },
    showToast(config) {
      const { title = "", description = "", media, buttons = [] } = config;
      const {
        style = {},
        position,
        transition,
        duration,
        branding,
      } = globalConfig;

      const wrapper = this.createWrapper(position);

      const toast = document.createElement("div");
      toast.className = "pinglet-toast";
      toastCount++;

      Object.assign(toast.style, {
        background: "#1f1f1f",
        color: "#fff",
        padding: "16px 20px",
        borderRadius: "12px",
        boxShadow: "0 6px 18px rgba(0,0,0,0.25)",
        fontFamily: "'Inter', sans-serif",
        fontSize: "14px",
        lineHeight: "1.5",
        maxWidth: "360px",
        minWidth: "280px",
        pointerEvents: "auto",
        position: "relative",
        opacity: "0",
        transform:
          transition === "slide"
            ? "translateX(100%)"
            : transition === "zoom"
            ? "scale(0.8)"
            : "none",
        transition: "all 0.4s ease",
        ...(toastCount >= 4 ? { opacity: 0.8, scale: 0.95 } : {}),
        ...style,
      });

      // Close Button
      const closeBtn = document.createElement("span");
      closeBtn.innerHTML = "&times;";
      Object.assign(closeBtn.style, {
        position: "absolute",
        top: "6px",
        right: "10px",
        cursor: "pointer",
        fontSize: "18px",
        color: "#aaa",
      });
      closeBtn.onclick = () => this.removeToast(toast);
      toast.appendChild(closeBtn);

      // Media/Icon
      if (media) {
        if (media.type === "icon") {
          const iconRow = document.createElement("div");
          iconRow.innerHTML = `<span style="font-size:14px;margin-right:8px;">${media.src}</span><strong>${title}</strong>`;
          toast.appendChild(iconRow);
        } else if (media.type === "image" || media.type === "video") {
          const mediaEl = this.createMediaElement(media);
          toast.appendChild(mediaEl);

          const titleEl = document.createElement("div");
          titleEl.innerHTML = `<strong>${title}</strong>`;
          toast.appendChild(titleEl);
        }
      } else {
        const titleEl = document.createElement("div");
        titleEl.innerHTML = `<strong>${title}</strong>`;
        toast.appendChild(titleEl);
      }

      // Description
      if (description) {
        const desc = document.createElement("div");
        desc.textContent = description;
        desc.style.color = "#ccc";
        toast.appendChild(desc);
      }

      // Buttons
      if (buttons.length) {
        const btnRow = document.createElement("div");
        Object.assign(btnRow.style, {
          display: "flex",
          gap: "10px",
          marginTop: "8px",
          flexWrap: "wrap",
        });

        buttons.forEach((btn) => {
          const btnEl = document.createElement("button");
          btnEl.type = "button";
          btnEl.className = `pinglet-toast-btn-${toastCount}`;
          btnEl.textContent = btn.text;
          Object.assign(btnEl.style, {
            padding: "6px 12px",
            background: "#333",
            border: "1px solid #555",
            color: "#fff",
            borderRadius: "6px",
            cursor: "pointer",
            fontSize: "13px",
          });
          if (btn.onClick) {
            if (typeof btn.onClick === "string") {
              try {
                btn.onClick = new Function(`return (${btn.onClick})`)();
              } catch (e) {
                console.warn("Invalid onClick function string:", btn.onClick);
                btn.onClick = null;
              }
            }

            if (typeof btn.onClick === "function") {
              btnEl.addEventListener("click", btn.onClick);
            }
          }
          btnRow.appendChild(btnEl);
        });

        toast.appendChild(btnRow);
      }

      // Branding (only once)
      if (branding?.show && !brandingEl) {
        brandingEl = document.createElement("div");
        brandingEl.innerHTML = branding.html;
        Object.assign(brandingEl.style, {
          fontSize: "11px",
          color: "#888",
          textAlign: "right",
          fontFamily: "'Inter', sans-serif",
          marginTop: "8px",
        });
      }
      wrapper.appendChild(toast);
      brandingEl && wrapper.appendChild(brandingEl);

      // Animate in
      setTimeout(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(0)";
      }, 10);

      // Timer logic
      let timeout = setTimeout(() => this.removeToast(toast), duration);

      toast.addEventListener("mouseenter", () => clearTimeout(timeout));
      toast.addEventListener("mouseleave", () => {
        timeout = setTimeout(() => removeToast(toast), 2000);
      });
    },

    removeToast(toast) {
      if (!toast) return;
      toast.style.opacity = "0";
      toast.style.transform = "translateX(100%)";
      setTimeout(() => {
        toast.remove();
        toastCount--;
        if (toastCount === 0 && brandingEl) {
          brandingEl.remove();
          brandingEl = null;
        }
      }, 400);
    },
  };

  const PingletSSE = {
    init({ endpoint, configuredDomain, projectIds = [] }) {
      const domain = location.hostname.replace(/^www\./, "");
      if (configuredDomain.length === 0) {
        this._showPopup(
          "Domain Configuration Error ",
          "Please ensure you are running Pinglet on a valid domain."
        );
        return;
      }
      if (projectIds.length === 0) {
        this._showPopup(
          "Project Configuration Error ",
          "Please add at least one project to your Pinglet configuration."
        );
        return;
      }
      // fetch projects and web configurations
      const matched = configuredDomain == domain;
      if (!matched) {
        this._showPopup(
          "Domain Configuration Error ",
          `Your current domain is not allowed. Please ensure it matches one of the following:
              ${configuredDomain}`
        );
        return;
      }
      projectIds.forEach((pid) => {
        const source = new EventSource(
          `${endpoint}/sse?projectId=${encodeURIComponent(pid)}`
        );
        source.onmessage = (e) => {
          try {
            const parsed = JSON.parse(e.data);

            const data = parsed.body
            Widget.showToast({
              title: data.title,
              description: data.description,
              media: data.media,
              buttons: data.buttons,
            });
           
          } catch (e) {
            console.log(e);
          }
        };
      });
    },
    _showNotification(config) {
      const {
        title = "",
        description = "",
        buttons = [],
        media = null,
        style = {},
        branding = {
          show: true,
          html: 'Powered by <a href="https://pinglet.enjoys.in" style="color:#4da6ff;text-decoration:none;" target="_blank">Pinglet</a> - Enjoys',
        },
      } = config;

      const wrapper = this._getWrapper(); // Must return container element

      const toast = document.createElement("div");
      toast.className = "pinglet-toast";

      // Default base style
      Object.assign(toast.style, {
        background: "#1f1f1f",
        color: "#fff",
        padding: "16px 20px",
        borderRadius: "12px",
        boxShadow: "0 6px 18px rgba(0, 0, 0, 0.25)",
        fontFamily: "'Inter', sans-serif",
        minWidth: "260px",
        maxWidth: "360px",
        opacity: "0",
        transform: "translateX(100%)",
        transition: "opacity 0.3s ease, transform 0.3s ease",
        display: "flex",
        flexDirection: "column",
        gap: "12px",
        ...style,
      });

      // Media handling
      if (media) {
        if (media.type === "icon") {
          const iconRow = document.createElement("div");
          Object.assign(iconRow.style, {
            display: "flex",
            alignItems: "center",
            gap: "10px",
            fontSize: "16px",
            fontWeight: "600",
          });

          const iconEl = document.createElement("span");
          iconEl.textContent = media.src;

          const titleEl = document.createElement("span");
          titleEl.textContent = title;

          iconRow.appendChild(iconEl);
          iconRow.appendChild(titleEl);
          toast.appendChild(iconRow);
        } else if (media.type === "image" || media.type === "video") {
          const mediaEl = document.createElement(media.type);
          Object.assign(mediaEl.style, {
            maxWidth: "100%",
            borderRadius: "8px",
          });
          mediaEl.src = media.src;
          if (media.type === "video") {
            mediaEl.controls = true;
          }
          toast.appendChild(mediaEl);

          const titleEl = document.createElement("div");
          titleEl.textContent = title;
          Object.assign(titleEl.style, {
            fontSize: "16px",
            fontWeight: "600",
          });
          toast.appendChild(titleEl);
        }
      } else {
        const titleEl = document.createElement("div");
        titleEl.textContent = title;
        Object.assign(titleEl.style, {
          fontSize: "16px",
          fontWeight: "600",
        });
        toast.appendChild(titleEl);
      }

      // Description
      if (description) {
        const descEl = document.createElement("div");
        descEl.textContent = description;
        Object.assign(descEl.style, {
          fontSize: "13.5px",
          color: "#ccc",
          lineHeight: "1.5",
        });
        toast.appendChild(descEl);
      }

      // Buttons
      if (Array.isArray(buttons) && buttons.length) {
        const btnRow = document.createElement("div");
        Object.assign(btnRow.style, {
          display: "flex",
          gap: "10px",
          marginTop: "6px",
        });

        for (const btn of buttons) {
          const btnEl = document.createElement("button");
          btnEl.textContent = btn.text || "Click";
          Object.assign(btnEl.style, {
            padding: "8px 14px",
            background: "#333",
            color: "#fff",
            border: "1px solid #444",
            borderRadius: "6px",
            fontSize: "13px",
            cursor: "pointer",
            transition: "background 0.3s",
          });
          btnEl.onmouseover = () => (btnEl.style.background = "#444");
          btnEl.onmouseout = () => (btnEl.style.background = "#333");

          if (typeof btn.onClick === "function") {
            btnEl.onclick = btn.onClick;
          }

          btnRow.appendChild(btnEl);
        }
        toast.appendChild(btnRow);
      }

      // Append toast
      wrapper.appendChild(toast);

      // Branding (outside toast)
      if (branding?.show !== false) {
        const brand = document.createElement("div");
        brand.innerHTML = branding?.html || "";
        Object.assign(brand.style, {
          fontSize: "11px",
          color: "#999",
          marginTop: "4px",
          textAlign: "right",
          fontFamily: "'Inter', sans-serif",
        });
        wrapper.appendChild(brand);

        // Cleanup both toast and brand
        setTimeout(() => {
          toast.remove();
          brand.remove();
        }, 5000);
      } else {
        setTimeout(() => toast.remove(), 5000);
      }

      // Animate in
      requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(0)";
      });
    },
    _showPopup(
      title,
      description,
      buttons = [
        {
          text: "See Docs",
          onClick: () =>
            window.open("https://pinglet.enjoys.in/docs", "_blank"),
        },
      ],
      icon = "⚠️"
    ) {
      const containerId = "toastContainer";
      let container = document.getElementById(containerId);

      if (!container) {
        container = document.createElement("div");
        container.id = containerId;
        Object.assign(container.style, {
          position: "fixed",
          bottom: "24px",
          right: "24px",
          zIndex: "9999",
          display: "flex",
          flexDirection: "column",
          gap: "4px",
          alignItems: "flex-end",
        });
        document.body.appendChild(container);
      }

      // Create toast element
      const toast = document.createElement("div");
      Object.assign(toast.style, {
        background: "#1f1f1f",
        color: "#fff",
        padding: "16px 20px",
        borderRadius: "12px",
        boxShadow: "0 6px 18px rgba(0, 0, 0, 0.25)",
        fontFamily: "'Inter', sans-serif",
        minWidth: "260px",
        maxWidth: "340px",
        opacity: "0",
        transform: "translateX(100%)",
        transition: "opacity 0.3s ease, transform 0.3s ease",
        display: "flex",
        flexDirection: "column",
        gap: "10px",
      });

      // Icon + Title
      const iconTitleRow = document.createElement("div");
      Object.assign(iconTitleRow.style, {
        display: "flex",
        alignItems: "center",
        gap: "10px",
        fontSize: "16px",
        fontWeight: "600",
      });

      const iconEl = document.createElement("div");
      iconEl.textContent = icon;

      const titleEl = document.createElement("div");
      titleEl.textContent = title;

      iconTitleRow.appendChild(iconEl);
      iconTitleRow.appendChild(titleEl);
      toast.appendChild(iconTitleRow);

      // Description
      if (description) {
        const descEl = document.createElement("div");
        descEl.textContent = description;
        Object.assign(descEl.style, {
          fontSize: "13.5px",
          fontWeight: "400",
          color: "#ddd",
          lineHeight: "1.5",
        });
        toast.appendChild(descEl);
      }

      // Buttons
      if (Array.isArray(buttons) && buttons.length) {
        const btnRow = document.createElement("div");
        Object.assign(btnRow.style, {
          marginTop: "8px",
          display: "flex",
          gap: "10px",
          justifyContent: "flex-start",
        });

        for (const btn of buttons) {
          const btnEl = document.createElement("button");
          btnEl.textContent = btn.text || "Click";
          Object.assign(btnEl.style, {
            padding: "8px 14px",
            background: "#333",
            color: "#fff",
            border: "1px solid #444",
            borderRadius: "6px",
            fontSize: "13px",
            cursor: "pointer",
            transition: "background 0.3s",
          });

          btnEl.onmouseover = () => (btnEl.style.background = "#444");
          btnEl.onmouseout = () => (btnEl.style.background = "#333");

          if (typeof btn.onClick === "function") {
            btnEl.addEventListener("click", btn.onClick);
          }

          btnRow.appendChild(btnEl);
        }

        toast.appendChild(btnRow);
      }

      // Add toast to container
      container.appendChild(toast);

      // External footer (outside toast)
      const footer = document.createElement("div");
      footer.innerHTML = `Powered by <a href="https://pinglet.enjoys.in" target="_blank" style="color:#4da6ff;text-decoration:none;">Pinglet</a> - Enjoys`;
      Object.assign(footer.style, {
        fontSize: "11px",
        color: "#999",
        marginTop: "4px",
        textAlign: "right",
        fontFamily: "'Inter', sans-serif",
      });
      container.appendChild(footer);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateX(0)";
      });

      // Auto-remove after 5s
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateX(100%)";
        setTimeout(() => {
          toast.remove();
          footer.remove(); // Also remove footer when toast is gone
        }, 500);
      }, 5000);
    },
    _getWrapper() {
      let wrap = document.getElementById("pinglet-wrapper");
      if (!wrap) {
        wrap = document.createElement("div");
        wrap.id = "pinglet-wrapper";
        wrap.style =
          "position:fixed;bottom:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;max-width:300px;font-family:sans-serif";
        document.body.appendChild(wrap);
      }
      // this._addBranding(wrap);
      return wrap;
    },
    _addBranding(wrap) {
      if (!document.getElementById("pinglet-brand")) {
        const el = document.createElement("div");
        el.id = "pinglet-brand";
        el.style = "font-size:10px;text-align:right;color:#aaa;margin-top:8px";
        el.innerHTML = "Powered by <strong>Pinglet</strong> – Enjoys";
        wrap.appendChild(el);
      }
    },
  };
  global.PingletWidget = PingletSSE;
})(window);
