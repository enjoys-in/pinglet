name: PR Events Webhook

on:
  pull_request:
    types:
      - opened
      - closed
      - reopened
      - edited
      - ready_for_review
      - converted_to_draft
  pull_request_review:
    types:
      - submitted
  pull_request_review_comment:
    types:
      - created
  issue_comment:
    types:
      - created

jobs:
  notify-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Send PR Event to Webhook
        run: |
          # Extract event data
          ACTION="${{ github.event.action }}"

          # For issue_comment events, PR number is in issue.number
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
            AUTHOR="${{ github.event.issue.user.login }}"
            PR_TITLE="${{ github.event.issue.title }}"
            PR_URL="${{ github.event.issue.html_url }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
          fi

          MERGED="${{ github.event.pull_request.merged }}"
          MERGED_BY="${{ github.event.pull_request.merged_by.login }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          REPO="${{ github.repository }}"

          # Function to map GitHub username to Teams name
          map_username() {
            local github_user="$1"
            case "$github_user" in
              "KomalSrinivasan") echo "Komal Vardhan Lolugu" ;;
              "piyushgarg-dev") echo "Piyush Garg (DevOps)" ;;
              "rbadisa24") echo "Rajendra Badisa (Dev Ops)" ;;
              "raghavendracs") echo "Raghavendra Prasad" ;;
              "ruru-m07") echo "Ruru (Frontend Dev)" ;;
              "Sima-Bharti") echo "Sima-Bharti (Frontend Dev)" ;;
              "x64nik") echo "HrushiKesh (Dev Ops)" ;;
              "vishnumallela") echo "Vishnu (Frontend Dev)" ;;
              "Tharun-Goud1") echo "Tharun (Frontend Dev)" ;;
              *) echo "$github_user" ;;
            esac
          }

          # Map usernames to Teams names
          AUTHOR_TEAMS=$(map_username "$AUTHOR")
          MERGED_BY_TEAMS=$(map_username "$MERGED_BY")

          # Get current timestamp in IST
          TIMESTAMP=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")

          # Build title and description based on action
          case "$ACTION" in
            "opened")
              TITLE="PR #${PR_NUMBER} opened by ${AUTHOR_TEAMS}"
              DESCRIPTION="A new update is available for this pull request. Please review on this PR."
              STATUS="Opened"
              ;;
            "closed")
              if [ "$MERGED" = "true" ]; then
                TITLE="PR #${PR_NUMBER} merged by ${MERGED_BY_TEAMS}"
                DESCRIPTION="This pull request has been merged successfully."
                STATUS="Merged"
              else
                TITLE="PR #${PR_NUMBER} closed by ${AUTHOR_TEAMS}"
                DESCRIPTION="This pull request has been closed without merging."
                STATUS="Closed"
              fi
              ;;
            "converted_to_draft")
              TITLE="PR #${PR_NUMBER} marked as Draft by ${AUTHOR_TEAMS}"
              DESCRIPTION="This pull request has been converted to draft status."
              STATUS="Draft"
              ;;
            "ready_for_review")
              TITLE="PR #${PR_NUMBER} is ready for review"
              DESCRIPTION="A new update is available for this pull request. Please review on this PR."
              STATUS="Ready for Review"
              ;;
            "edited")
              TITLE="PR #${PR_NUMBER} title/description updated"
              DESCRIPTION="The pull request details have been updated."
              STATUS="Edited"
              ;;
            "reopened")
              TITLE="PR #${PR_NUMBER} reopened by ${AUTHOR_TEAMS}"
              DESCRIPTION="A new update is available for this pull request. Please review on this PR."
              STATUS="Reopened"
              ;;
            "submitted")
              REVIEWER="${{ github.event.review.user.login }}"
              REVIEWER_TEAMS=$(map_username "$REVIEWER")
              REVIEW_STATE="${{ github.event.review.state }}"
              TITLE="PR #${PR_NUMBER} review ${REVIEW_STATE} by ${REVIEWER_TEAMS}"
              DESCRIPTION="A review has been submitted for this pull request."
              STATUS="Review ${REVIEW_STATE}"
              ;;
            "created")
              if [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
                COMMENTER="${{ github.event.comment.user.login }}"
                COMMENTER_TEAMS=$(map_username "$COMMENTER")
                TITLE="New review comment on PR #${PR_NUMBER} by ${COMMENTER_TEAMS}"
                DESCRIPTION="A new review comment has been added to this pull request."
                STATUS="Review Comment"
              elif [ "${{ github.event_name }}" = "issue_comment" ] && [ -n "$PR_NUMBER" ]; then
                COMMENTER="${{ github.event.comment.user.login }}"
                COMMENTER_TEAMS=$(map_username "$COMMENTER")
                TITLE="New comment on PR #${PR_NUMBER} by ${COMMENTER_TEAMS}"
                DESCRIPTION="A new comment has been added to this pull request."
                STATUS="Comment Added"
              fi
              ;;
            *)
              TITLE="PR #${PR_NUMBER} - ${ACTION}"
              DESCRIPTION="A new update is available for this pull request."
              STATUS="${ACTION}"
              ;;
          esac

          # Prepare Teams Adaptive Card JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "type": "message",
            "summary": "New Activity on GitHub Pull Request Notification",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "contentUrl": "",
                "content": {
                  "type": "AdaptiveCard",
                  "body": [
                    {
                      "type": "Container",
                      "verticalContentAlignment": "Center",
                      "items": [
                        {
                          "type": "ColumnSet",
                          "style": "default",
                          "columns": [
                            {
                              "type": "Column",
                              "width": "auto",
                              "verticalContentAlignment": "Center",
                              "items": [
                                {
                                  "type": "Image",
                                  "width": "32px",
                                  "style": "Person",
                                  "url": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEbeZfwVwamVRTBSj8PYNZtzyD5Mb7FHyX9w&s",
                                  "altText": "GitHub Logo"
                                }
                              ]
                            },
                            {
                              "type": "Column",
                              "width": "stretch",
                              "items": [
                                {
                                  "type": "TextBlock",
                                  "size": "Medium",
                                  "weight": "Bolder",
                                  "text": "**${TITLE}**"
                                },
                                {
                                  "type": "TextBlock",
                                  "size": "Small",
                                  "weight": "Default",
                                  "text": "${DESCRIPTION}",
                                  "isSubtle": false,
                                  "spacing": "None",
                                  "wrap": true
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "FactSet",
                      "separator": false,
                      "facts": [
                        {
                          "title": "Event:",
                          "value": "Pull Request"
                        },
                        {
                          "title": "Status:",
                          "value": "${STATUS}"
                        },
                        {
                          "title": "Repository:",
                          "value": "${REPO}"
                        },
                        {
                          "title": "Triggered At:",
                          "value": "${TIMESTAMP}"
                        }
                      ]
                    },
                    {
                      "type": "ActionSet",
                      "actions": [
                        {
                          "type": "Action.OpenUrl",
                          "title": "View PR #${PR_NUMBER}",
                          "url": "${PR_URL}"
                        }
                      ]
                    }
                  ],
                  "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "version": "1.5"
                }
              }
            ]
          }
          EOF
          )

          # Send to webhook
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "${{ secrets.TEAMS_WEBHOOK_URL }}"

          echo "Teams notification sent: $TITLE"
